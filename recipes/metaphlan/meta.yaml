{% set name = "metaphlan" %}
{% set version = "4.2.0" %}

package:
  name: {{ name }}
  version: {{ version }}

source:
  url: https://github.com/biobakery/MetaPhlAn/archive/{{version}}.tar.gz
  sha256: c9b09f850a9ea66de85f6dd68a0103faf64fa8e8945f1b405ee1121abff34fc1

build:
  number: 0
  noarch: python
  script: {{ PYTHON }} -m pip install . --no-deps --no-build-isolation --no-cache-dir --use-pep517 -vvv
  entry_points:
    - metaphlan = metaphlan.metaphlan:main
    - strainphlan = metaphlan.strainphlan:main
    - add_metadata_tree.py = metaphlan.utils.add_metadata_tree:main
    - extract_markers.py = metaphlan.utils.extract_markers:main
    - merge_metaphlan_tables.py  = metaphlan.utils.merge_metaphlan_tables:main
    - plot_tree_graphlan.py = metaphlan.utils.plot_tree_graphlan:main
    - read_fastx.py = metaphlan.utils.read_fastx:main
    - sample2markers.py = metaphlan.utils.sample2markers:main
    - strain_transmission.py = metaphlan.utils.strain_transmission:main
    - sgb_to_gtdb_profile.py = metaphlan.utils.sgb_to_gtdb_profile:main
    - metaphlan2krona.py = metaphlan.utils.metaphlan2krona:main
    - run_treeshrink.py = metaphlan.utils.treeshrink.run_treeshrink:main
    - treeshrink.py = metaphlan.utils.treeshrink.treeshrink:main
  run_exports:
    - {{ pin_subpackage('metaphlan', max_pin='x') }}

requirements:
  host:
    - python >=3.7
    - pip
    - setuptools
  run:
    - python >=3.7
    - numpy
    - h5py
    - biom-format
    - biopython
    - pandas
    - scipy
    - hclust2
    - requests
    - dendropy
    - pysam
    - cmseq
    - phylophlan
    - bowtie2 >=2.3.0
    - minimap2 >=2.26
    - matplotlib-base
    - blast
    - muscle >=3.8.1551
    - raxml >=8.2.10
    - samtools
    - r-base >=4
    - r-essentials
    - r-optparse
    - r-rbiom
    - r-ape
    - r-compositions
    - r-biocmanager
    - bioconductor-microbiome

test:
  commands:
    - metaphlan -v
    - strainphlan -h
    - extract_markers.py -h
    - merge_metaphlan_tables.py -h
    - read_fastx.py -h
    - add_metadata_tree.py -h
    - plot_tree_graphlan.py -h
    - sample2markers.py -h
    - strain_transmission.py -h
    - sgb_to_gtdb_profile.py -h
    - metaphlan2krona.py -h    
    - run_treeshrink.py -h
    - treeshrink.py -h
    - bowtie2-align-s --help

about:
  home: "https://github.com/biobakery/metaphlan"
  license: MIT
  license_family: MIT
  license_file: "license.txt"
  summary: "Metagenomic Phylogenetic Analysis."
  description: |
    MetaPhlAn is a computational tool for profiling the composition of microbial
    communities (Bacteria, Archaea and Eukaryotes) from metagenomic
    shotgun sequencing data with species level resolution. From version 2.0
    MetaPhlAn is also able to identify specific strains (in the not-so-frequent
    cases in which the sample contains a previously sequenced strains) and to
    track strains across samples for all species.
  dev_url: "https://github.com/biobakery/metaphlan"
  doc_url: "https://github.com/biobakery/MetaPhlAn/wiki/MetaPhlAn-4"

extra:
  identifiers:
    - doi:10.1038/nmeth.2066
    - biotools:metaphlan
    - usegalaxy-eu:metaphlan
