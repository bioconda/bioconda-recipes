{% set name = "PxBLAT" %}
{% set version = "1.2.1" %}
{% set sha256 = "b61337bde541be6fc933059d42c51364490775071d96de53a60cefeb0ac16e1a" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  url: https://pypi.org/packages/source/{{ name[0] }}/{{ name }}/pxblat-{{ version }}.tar.gz
  sha256: {{ sha256 }}

build:
  number: 1
  # osx x86_64 error: OSError: [Errno 63] File name too long: "/usr/local/Homebrew/Library/Homebrew/startup/config.rb:84:in 'File.expand_path'
  skip: True  # [py > 311 or (osx and x86_64)]
  script:
    - export LDFLAGS="${LDFLAGS} -L${PREFIX}/lib"
    - export LDFLAGS="${LDFLAGS} -Wl,-rpath,${PREFIX}/lib -headerpad_max_install_names"  # [osx]
    # 1. 修改common.c文件中的三个错误位置
    - sed -i.bak 's/freeFunc(&el);/freeFunc();/g' src/pxblat/extc/src/core/common.c
    - sed -i.bak 's/free(el);/free();/g' src/pxblat/extc/src/core/common.c
    - sed -i.bak 's/freeFunc(el->val);/freeFunc();/g' src/pxblat/extc/src/core/common.c
    - sed -i.bak 's/if (format != NULL && args != NULL)/if (format != NULL)/g' ./src/pxblat/extc/src/aux/htmshell.c
    - sed -i.bak 's/freeFunc(&hel->val);/freeFunc();/g' src/pxblat/extc/src/core/hash.c
    - {{ PYTHON }} -m pip install . --no-deps --no-build-isolation --no-cache-dir -vvv
  entry_points:
    - pxblat = pxblat.cli.cli:app
  run_exports:
    - {{ pin_subpackage(name|lower, max_pin="x") }}

requirements:
  build:
    - {{ compiler('cxx') }}
    - make  # 如果使用Makefile
    - pkg-config
  host:
    - python
    - pip
    - poetry-core >=1.2.0
    - pybind11 >2.9.1
    - setuptools >=46.4
    - pysimdjson >=6.0.2
    - zlib
  run:
    - python
    - loguru
    - pybind11 >=2.10.4
    - rich
    - pysimdjson >=6.0.2
    - biopython
    - typer
    - deprecated
    - mashumaro
    - urllib3

test:
  imports:
    - pxblat
  commands:
    - pxblat -h

about:
  home: "https://github.com/ylab-hi/pxblat"
  license: OTHER
  license_file: LICENSE
  summary: "PxBLAT: An Efficient and Ergonomics Python Binding Library for BLAT."
  dev_url: "https://pypi.org/project/pxblat"
  doc_url: "https://pxblat.readthedocs.io/en/latest"

extra:
  recipe-maintainers:
    - yangyangli
  identifiers:
    - doi:10.1101/2023.08.02.551686
  additional-platforms:
    # missing pysimdjson
    #- linux-aarch64
    - osx-arm64
