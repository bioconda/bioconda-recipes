{% set version = "1.0.0" %}
{% set pnetcdf_version = "1.14.0" %}
{% set hdf5_version = "1.14.5" %}
{% set netcdf_c_version = "4.9.2" %}
{% set netcdf_fortran_version = "4.6.1" %}
{% set esmf_version = "8.8.0" %}
{% set build = 0 %}

{% set mpi_prefix = "mpi_" + mpi %}
{% set mpi_package = mpi %}

{% if 'mvapich_ucx' in mpi %}
{% set mpi_prefix = "mvapich_ucx" %}
{% set mpi_package = 'mvapich * ucx*' %}
{% elif 'mvapich_ofi' in mpi %}
{% set mpi_prefix = "mvapich_ofi" %}
{% set mpi_package = 'mvapich * ofi*' %}
{% endif %}

package:
  name: esme
  version: {{ version }}

source:
  - url: https://parallel-netcdf.github.io/Release/pnetcdf-{{ pnetcdf_version }}.tar.gz
    sha245: 575f189fb01c53f93b3d6ae0e506f46e19694807c81af0b9548e947995acf704  # 1.14.0
    folder: esme_pnetcdf
  - url: https://github.com/HDFGroup/hdf5/releases/download/hdf5_{{ hdf5_version }}/hdf5-{{ hdf5_version }}.tar.gz
    sha256: ec2e13c52e60f9a01491bb3158cb3778c985697131fc6a342262d32a26e58e44  # 1.14.5
    folder: esme_hdf5
  - url: https://github.com/Unidata/netcdf-c/archive/refs/tags/v{{ netcdf_c_version }}.tar.gz
    sha256: bc104d101278c68b303359b3dc4192f81592ae8640f1aee486921138f7f88cb7  # 4.9.2
    folder: esme_netcdf-c
  - url: https://downloads.unidata.ucar.edu/netcdf-fortran/{{ netcdf_fortran_version }}/netcdf-fortran-{{ netcdf_fortran_version }}.tar.gz
    sha256: b50b0c72b8b16b140201a020936aa8aeda5c79cf265c55160986cd637807a37a  # 4.6.1
    folder: esme_netcdf-fortran
  - url: https://github.com/esmf-org/esmf/archive/refs/tags/v{{ esmf_version }}.tar.gz
#   sha256: ed057eaddb158a3cce2afc0712b49353b7038b45b29aee86180f381457c0ebe7  # 8.6.0
    sha256: f89327428aeef6ad34660b5b78f30d1c55ec67efb8f7df1991fdaa6b1eb3a27c  # 8.8.0
    folder: esme_esmf

build:
  number: {{ build }}
  string: {{ mpi_prefix }}_h{{ PKG_HASH }}_{{ build }}
  skip: true  # [win or osx]
  run_exports:
    - {{ pin_subpackage('esme', max_pin='x.x.x') }}
  ignore_run_exports:
    - libacl

outputs:

  - name: esme_pnetcdf
    script: build_pnetcdf.sh
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - {{ compiler('fortran') }}
        - make
        - m4
      host:
        - {{ mpi_package }}
      run:
        - esme_pnetcdf
    test:
      commands:
        - export PATH=$PATH:${PREFIX}/bin
        - pnetcdf-config --all

  - name: esme_hdf5
    script: build_hdf5.sh
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - {{ compiler('fortran') }}
        - make
      host:
        - {{ mpi_package }}
        - libaec
        - libacl
        - zlib
      run:
        - esme_hdf5
    test:
      commands:
        - export PATH=$PATH:${PREFIX}/bin
        - h5pfc -showconfig

  - name: esme_netcdf-c
    script: build_netcdf-c.sh
    requirements:
      build:
        - {{ compiler('c') }}
        - make
        - m4
      host:
        - {{ mpi_package }}
        - esme_hdf5
        - esme_pnetcdf
        - libcurl
        - libxml2
        - zlib
      run:
        - esme_hdf5
        - esme_netcdf-c
    test:
      commands:
        - export PATH=$PATH:${PREFIX}/bin
        - nc-config --all

  - name: esme_netcdf-fortran
    script: build_netcdf-fortran.sh
    requirements:
      build:
        - {{ compiler('fortran') }}
        - make
        - m4
      host:
        - esme_netcdf-c
      run:
        - esme_netcdf-c
        - esme_netcdf-fortran
    test:
      commands:
        - export PATH=$PATH:${PREFIX}/bin
        - nf-config --all

  - name: esme_esmf
    script: build_esmf.sh
    requirements:
      build:
        - cmake
        - {{ compiler('cxx') }}
        - {{ compiler('fortran') }}
        - make
      host:
        - esme_hdf5
        - esme_pnetcdf
        - esme_netcdf-c
        - esme_netcdf-fortran
        - openblas
        - parallelio
      run:
        - esme_hdf5
        - esme_pnetcdf
        - esme_netcdf-c
        - esme_netcdf-fortran
        - openblas
        - parallelio
    test:
      commands:
        - if test -f ${ESMFMKFILE}; then echo "ESMF makefile found"; else echo "ESMF makefile not found"; exit 1; fi

  - name: esme
    script: build_esme.sh
    requirements:
      run:
        - cmake
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
        - {{ compiler('fortran') }}
        - {{ mpi_package }}
        - esme_esmf

about:
  home: https://github.com/j34ni/bioconda-recipes
  license: BSD-3-Clause
  license_family: BSD
  license_file: LICENSE_ESME
  summary: Earth System Modelling Environment (ESME) - A bundle for scientific computing packages for climate modelling with MPI support.
  description: |
    ESME (Earth System Modelling Environment) is a package designed to facilitate the installation and management of various scientific computing libraries with support for multiple MPI implementations. This bundle currently includes:
  
      - **PnetCDF**:
      - **Version**: {{ pnetcdf_version }}
      - **Home**: https://parallel-netcdf.github.io/
      - **License**: Custom
      - **License File**: LICENSE_PNETCDF
      - **Description**: PnetCDF is a high-performance parallel I/O library for accessing files in netCDF formats.

    - **HDF5**: 
      - **Version**: {{ hdf5_version }}
      - **Home**: https://www.hdfgroup.org/
      - **License**: BSD-3-Clause
      - **License File**: LICENSE_HDF5
      - **Description**: HDF5 (Hierarchical Data Format 5) is a file format and set of tools designed for managing, storing, and organizing large and complex data.

    - **netCDF_C**:
      - **Version**: {{ netcdf_c_version }}
      - **Home**: http://www.unidata.ucar.edu/software/netcdf/
      - **License**: MIT
      - **License File**: COPYRIGHT
      - **Description**: NetCDF-C is the C implementation of the Unidata's network Common Data Form (netCDF), providing an interface for storing, accessing, and sharing array-oriented scientific data in a platform-independent format.

    - **netCDF_Fortran**:
      - **Version**: {{ netcdf_fortran_version }}
      - **Home**: http://www.unidata.ucar.edu/software/netcdf/
      - **License**: MIT
      - **License File**: COPYRIGHT
      - **Description**: NetCDF-Fortran provides Fortran language bindings for the NetCDF library, allowing Fortran programs to read and write scientific data in netCDF format.

    - **ESMF**:
      - **Version**: {{ esmf_version }}
      - **Home**: http://earthsystemmodeling.org/
      - **License**: Custom
      - **License File**: LICENSE_ESMF
      - **Description**: The Earth System Modeling Framework (ESMF) is a suite of software tools for developing high-performance, multi-component Earth science modeling applications.
extra:
  recipe-maintainers:
    - j34ni
