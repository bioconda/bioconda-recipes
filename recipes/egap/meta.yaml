{% set name = "egap" %}
{% set version = "3.0.0b" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  - url: https://github.com/iPsychonaut/EGAP/archive/refs/tags/v{{ version }}.tar.gz
    sha256: 2011e6d361a1e223e57d71220b994e4199c4b476ad76af64fb5aaace4c36229b
  - url: https://github.com/iPsychonaut/runner/archive/refs/tags/v0.0.0.tar.gz
    sha256: 4e67bb1e970dadb86425cb2698e0e2e34f70d78cbf77a32f73c13f66dffb55fc
    
build:
  noarch: python
  number: 0
  script: |
    set -eux
    export PYTHONDONTWRITEBYTECODE=1
    
    # show what's in the source directory
    echo "Contents of $SRC_DIR:"
    ls -R "$SRC_DIR"

    # install code under lib/egap
    mkdir -p "${PREFIX}/lib/egap"
    cp -r ./* "${PREFIX}/lib/egap/"

    # create a small wrapper in bin/EGAP that sets PYTHONPATH
    mkdir -p "${PREFIX}/bin"
    echo '#!/usr/bin/env bash' > "${PREFIX}/bin/EGAP"
    echo 'export PYTHONPATH="${PREFIX}/lib/egap"' >> "${PREFIX}/bin/EGAP"
    echo 'exec python "${PREFIX}/lib/egap/EGAP.py" "$@"' >> "${PREFIX}/bin/EGAP"
    chmod +x "${PREFIX}/bin/EGAP"

  run_exports:
    - {{ pin_subpackage('egap', max_pin="x") }}

requirements:
  host:
    - python >=3.8,<3.9
  run:
    - python >=3.8,<3.9
    - masurca >=4.1.2
    - quast >=5.2.0
    - compleasm >=0.2.7
    - busco >=5.8.2
    - biopython >=1.81
    - ragtag >=2.1.0
    - nanoplot >=1.43.0
    - termcolor >=2.3.0
    - minimap2 >=2.28
    - bwa-mem2 >=2.2.1
    - bamtools >=2.5.2
    - tgsgapcloser >=1.2.1
    - abyss >=2.0.2
    - sepp >=4.5.1
    - psutil >=6.0.0
    - beautifulsoup4 >=4.12.3
    - ncbi-datasets-cli >=16.39.0
    - matplotlib-base >=3.7.3
    - trimmomatic ==0.39
    - pilon >=1.22
    - fastqc >=0.12.1
    - bbmap >=39.15
    - racon >=1.5.0
    - kmc >=3.2.4
    - spades >=4.0.0
    - purge_dups >=1.2.6
    - flye >=2.9.5
    - pbccs >=6.4.0
    - hifiasm >=0.21.0
    - gfatools >=0.5
    - bifrost >=1.3.5
    - ratatosk >=0.9.0
    - mafft
    - iqtree
    - ete3
    - trimal
    - filtlong
    - pandas
    - gffutils
    - pysam
    - scipy
    - clinker-py
    - packaging
    - meson
    - pigz ==2.8
    - sra-tools ==3.1.1
  run_constrained:
    - libgd  # allow libgd but donâ€™t enforce its binaries

test:
  commands:
    - EGAP --help
    - which masurca
    - which quast
    - which minimap2
    - which bwa-mem2
    - which trimmomatic
    - which fasterq-dump
    - which pigz

about:
  home: https://github.com/iPsychonaut/EGAP
  license: BSD 3-Clause License
  license_file: LICENSE
  summary: "EGAP pipeline for genome assembly and QC analysis"
  description: |
    EGAP (Entheome Genome Assembly Pipeline) is a versatile bioinformatics pipeline
    for hybrid genome assembly from Oxford Nanopore, Illumina, and PacBio data.
    It supports multiple input modes and assembly methods, selecting the best
    assembly based on metrics like BUSCO completeness, contig count, N50/L50, and GC%.

extra:
  notes: |
    Installs your code under lib/egap and places a small launcher script in bin/EGAP
    which sets PYTHONPATH so that imports like `from bin.utilities` resolve correctly.
  recipe-maintainers:
    - iPsychonaut
