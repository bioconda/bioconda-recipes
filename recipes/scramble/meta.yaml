{% set version = "1.0.1" %}
{% set github = "https://github.com/GeneDx/scramble" %}

package:
  name: scramble
  version: {{ version }}

source:
  url: {{ github }}/archive/v{{ version }}.tar.gz
  sha256: 8ee9965f04bf860951aca74c5524e185156a11b709a9a67874ffaed537001554

build:
  number: 0

requirements:
  build:
    - {{ compiler('c') }}
  host:
    - htslib
  run:
    - r-base
    - r-optparse
    - r-rblast
    - r-stringr
    - bioconductor-rsamtools

test:
  commands:
    - cluster_identifier -v 2>&1 >/dev/null | grep {{ version }}
    - cluster_identifier validation/test.bam | diff - validation/test.clusters.txt
    - >
      scramble.sh
      --cluster-file "$(pwd)/validation/test.clusters.txt"
      --out-name "$(pwd)/validation/test_conda"
      --ref "$(pwd)/validation/test.fa"
      --eval-dels
      --eval-meis
    - diff validation/test_conda_MEIs.txt validation/test_MEIs.txt
    - diff validation/test_conda_PredictedDeletions.txt validation/test_PredictedDeletions.txt
    - diff -I '^##reference=' validation/test_conda.vcf validation/test.vcf
  source_files:
    - validation/test*

about:
  home: {{ github }}
  license: CC
  license_file: LICENSE
  summary: Soft Clipped Read Alignment Mapper
  description: |
    SCRAMble identifies clusters of soft clipped reads in a BAM file, builds consensus sequences,
    aligns to representative L1Ta, AluYa5, and SVA-E sequences, and outputs MEI calls

extra:
  identifiers:
    - doi:10.1038/s41436-020-0749-x
  notes: |
    SCRAMble runs as a two-step process. First cluster_identifier is used to generate soft-clipped
    read cluster consensus sequences. Second, SCRAMble.R analyzes the cluster file for likely MEIs.
    Custom wrapper script scramble.sh is provided to help setting location of SCRAMble.R script,
    and values for --install-dir and --mei-refs params.
