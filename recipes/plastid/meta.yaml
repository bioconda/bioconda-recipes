{% set name = "plastid" %}
{% set version = "0.6.1" %}

package:
  name: {{ name }}
  version: {{ version }}

source:
  url: https://pypi.org/packages/source/{{ name[0] }}/{{ name }}/plastid-{{ version }}.tar.gz
  sha256: 7a63f8a3b760e9c91e7c6d95ff781d9a8f2f967d705fcd8555ebb1e6d3b08b7b

build:
  number: 3
  # We're not rebuilding old biopython versions on conda-forge for this
  skip: True  # [py > 39]
  entry_points:
    - phase_by_size = plastid.bin.phase_by_size:main
    - cs = plastid.bin.cs:main
    - crossmap = plastid.bin.crossmap:main
    - metagene = plastid.bin.metagene:main
    - gff_parent_types = plastid.bin.gff_parent_types:main
    - findjuncs = plastid.bin.findjuncs:main
    - make_wiggle = plastid.bin.make_wiggle:main
    - get_count_vectors = plastid.bin.get_count_vectors:main
    - slidejuncs = plastid.bin.slidejuncs:main
    - psite = plastid.bin.psite:main
    - test_table_equality = plastid.bin.test_table_equality:main
    - counts_in_region = plastid.bin.counts_in_region:main
    - reformat_transcripts = plastid.bin.reformat_transcripts:main
  script:
    - export LDFLAGS="${LDFLAGS} -L${PREFIX}/lib"
    - export CPPFLAGS="${CPPFLAGS} -I${PREFIX}/include"
    - export CFLAGS="${CFLAGS} -O3 -Wno-deprecated-declarations -Wno-int-conversion -Wno-sign-compare"
    - {{ PYTHON }} -m pip install . --no-deps --no-build-isolation --no-cache-dir --use-pep517 -vvv
  run_exports:
    - {{ pin_subpackage(name, max_pin="x.x") }}

requirements:
  build:
    - {{ compiler('c') }}
  host:
    - python
    - pip
    - cython
    - setuptools
    - numpy >=1.9.4,<=1.23.5  # numpy 1.24 removes np.TYPE (reported https://github.com/joshuagryphon/plastid/issues/55)
    - pysam
    - termcolor
    - scipy >=0.15.1
    - pandas >=0.17.0
    - matplotlib-base >=1.4.0
    - biopython >=1.64,<1.78  # 1.78 removed Bio.Alphabet (reported https://github.com/joshuagryphon/plastid/issues/45)
    - twobitreader >=3.0.0
    - zlib
    - openssl
    - htslib
  run:
    - python
    - numpy <=1.23.5
    - pysam
    - setuptools
    - cython
    - termcolor
    - scipy >=0.15.1
    - pandas >=0.17.0
    - matplotlib-base >=1.4.0
    - biopython >=1.64,<1.78
    - twobitreader >=3.0.0
    - bowtie
    - fastx_toolkit
    - htslib

test:
  imports:
    - plastid
  commands:
    - counts_in_region -h
    - cs -h
    - get_count_vectors -h
    - make_wiggle -h
    - metagene -h
    - phase_by_size -h
    - psite -h
    - crossmap -h
    - gff_parent_types -h
    - reformat_transcripts -h
    - findjuncs -h
    - slidejuncs -h

about:
  home: "https://github.com/joshuagryphon/plastid"
  license: "BSD-3-Clause"
  license_family: BSD
  summary: "plastid is a Python library for genomic analysis -- in particular, high-throughput sequencing data."
  dev_url: "https://github.com/joshuagryphon/plastid"
  doc_url: "https://plastid.readthedocs.io/en/latest"

extra:
  skip-lints:
    - cython_must_be_in_host  # Plastid mistakenly checks for Cython at runtime (pkg_resources.DistributionNotFound)
