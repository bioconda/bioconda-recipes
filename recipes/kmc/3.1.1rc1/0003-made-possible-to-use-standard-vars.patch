From f1bfbe3836852bc9d84de7c59d558603a48b6673 Mon Sep 17 00:00:00 2001
From: Ilya Shlyakhter <ilya@broadinstitute.org>
Date: Tue, 17 Jul 2018 18:31:33 -0400
Subject: [PATCH 3/3] made possible to use standard vars

---
 makefile | 41 ++++++++++++++++++++++-------------------
 1 file changed, 22 insertions(+), 19 deletions(-)

diff --git a/makefile b/makefile
index 6ec0c9c..cca9362 100644
--- a/makefile
+++ b/makefile
@@ -1,4 +1,4 @@
-all: kmc
+all: kmc kmc_dump kmc_tools
 
 KMC_BIN_DIR = bin
 KMC_MAIN_DIR = kmer_counter
@@ -6,14 +6,17 @@ KMC_API_DIR = kmc_api
 KMC_DUMP_DIR = kmc_dump
 KMC_TOOLS_DIR = kmc_tools
 
-CXX 	= g++
-CXXFLAGS	= -Wall -O3 -m64 -Wl,--whole-archive -pthread -Wl,--no-whole-archive -std=c++11 
-LDFLAGS	= -lm -O3 -Wl,--whole-archive -pthread -Wl,--no-whole-archive -std=c++11 
+CXX 	?= g++
+CXX_CMD = $(CXX) $(CPPFLAGS) $(CXXFLAGS)
+KMC_COMMON_CXXFLAGS = -Wall -O3 -m64 -Wl,--whole-archive -pthread -Wl,--no-whole-archive
+KMC_CXXFLAGS	= $(KMC_COMMON_CXXFLAGS) -std=c++11
+KMC_COMMON_LDFLAGS = -lm -O3 -Wl,--whole-archive -pthread -Wl,--no-whole-archive
+KMC_LDFLAGS	= $(KMC_COMMON_LDFLAGS) -std=c++11 
 
-KMC_TOOLS_CXXFLAGS	= -Wall -O3 -m64 -Wl,--whole-archive -pthread -Wl,--no-whole-archive -std=c++14
-KMC_TOOLS_LDFLAGS	= -lm -O3 -Wl,--whole-archive -pthread -Wl,--no-whole-archive -std=c++14
+KMC_TOOLS_CXXFLAGS	= $(KMC_COMMON_CXXFLAGS) -std=c++14
+KMC_TOOLS_LDFLAGS	= $(KMC_COMMON_LDFLAGS) -std=c++14
 
-DISABLE_ASMLIB = false
+DISABLE_ASMLIB ?= false
 
 KMC_OBJS = \
 $(KMC_MAIN_DIR)/kmer_counter.o \
@@ -62,7 +65,7 @@ $(KMC_TOOLS_DIR)/percent_progress.o
 KMC_TOOLS_LIBS = -lz -lbz2
 
 ifeq ($(DISABLE_ASMLIB),true)
-	CXXFLAGS += -DDISABLE_ASMLIB
+	KMC_CXXFLAGS += -DDISABLE_ASMLIB
 	KMC_TOOLS_CXXFLAGS += -DDISABLE_ASMLIB
 else
 	KMC_LIBS += \
@@ -72,32 +75,32 @@ else
 endif 	
 
 $(KMC_OBJS) $(KMC_DUMP_OBJS) $(KMC_API_OBJS): %.o: %.cpp
-	$(CXX) $(CXXFLAGS) -c $< -o $@
+	$(CXX_CMD) $(KMC_CXXFLAGS) -c $< -o $@
 
 $(KMC_TOOLS_OBJS): %.o: %.cpp
-	$(CXX) $(KMC_TOOLS_CXXFLAGS) -c $< -o $@
+	$(CXX_CMD) $(KMC_TOOLS_CXXFLAGS) -c $< -o $@
 
 $(KMC_MAIN_DIR)/raduls_sse2.o: $(KMC_MAIN_DIR)/raduls_sse2.cpp
-	$(CXX) $(CXXFLAGS) -msse2 -c $< -o $@
+	$(CXX_CMD) $(KMC_CXXFLAGS) -msse2 -c $< -o $@
 $(KMC_MAIN_DIR)/raduls_sse41.o: $(KMC_MAIN_DIR)/raduls_sse41.cpp
-	$(CXX) $(CXXFLAGS) -msse4.1 -c $< -o $@
+	$(CXX_CMD) $(KMC_CXXFLAGS) -msse4.1 -c $< -o $@
 $(KMC_MAIN_DIR)/raduls_avx.o: $(KMC_MAIN_DIR)/raduls_avx.cpp
-	$(CXX) $(CXXFLAGS) -mavx -fabi-version=0 -c $< -o $@
+	$(CXX_CMD) $(KMC_CXXFLAGS) -mavx -fabi-version=0 -c $< -o $@
 $(KMC_MAIN_DIR)/raduls_avx2.o: $(KMC_MAIN_DIR)/raduls_avx2.cpp
-	$(CXX) $(CXXFLAGS) -mavx2 -mfma -fabi-version=0 -c $< -o $@
+	$(CXX_CMD) $(KMC_CXXFLAGS) -mavx2 -mfma -fabi-version=0 -c $< -o $@
 $(KMC_MAIN_DIR)/instrset_detect.o: $(KMC_MAIN_DIR)/libs/vectorclass/instrset_detect.cpp
-	$(CXX) $(CXXFLAGS) -c $< -o $@
+	$(CXX_CMD) $(KMC_CXXFLAGS) -c $< -o $@
 
 kmc: $(KMC_OBJS) $(RADULS_OBJS) $(KMC_MAIN_DIR)/instrset_detect.o 
 	-mkdir -p $(KMC_BIN_DIR)
-	$(CXX) $(LDFLAGS) -o $(KMC_BIN_DIR)/$@ $^ $(KMC_LIBS)
+	$(CXX) -o $(KMC_BIN_DIR)/$@ $^ $(KMC_LIBS) $(LDFLAGS) $(KMC_LDFLAGS)
 kmc_dump: $(KMC_DUMP_OBJS) $(KMC_API_OBJS)
 	-mkdir -p $(KMC_BIN_DIR)
-	$(CXX) $(LDFLAGS) -o $(KMC_BIN_DIR)/$@ $^
+	$(CXX) -o $(KMC_BIN_DIR)/$@ $^ $(LDFLAGS) $(KMC_LDFLAGS)
 
 kmc_tools: $(KMC_TOOLS_OBJS) $(KMC_API_OBJS)
 	-mkdir -p $(KMC_BIN_DIR)
-	$(CXX) $(KMC_TOOLS_LDFLAGS) -o $(KMC_BIN_DIR)/$@ $^ $(KMC_TOOLS_LIBS)
+	$(CXX) -o $(KMC_BIN_DIR)/$@ $^ $(KMC_TOOLS_LIBS) $(LDFLAGS) $(KMC_TOOLS_LDFLAGS) 
 
 clean:
 	-rm $(KMC_MAIN_DIR)/*.o
@@ -106,4 +109,4 @@ clean:
 	-rm $(KMC_TOOLS_DIR)/*.o
 	-rm -rf bin
 
-all: kmc kmc_dump kmc_tools
+
-- 
2.14.4

