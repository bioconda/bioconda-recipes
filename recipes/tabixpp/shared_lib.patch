Description: Build shared lib with bioconda's htslib
 The upstream repo includes htslib as a submodule that gets
 built with the tabixpp code. This patch changes this to use
 bioconda's shared libhts from the archive.
 Also builds a shared library instead of a static one.
Author: Sascha Steinbiss <sascha@steinbiss.name> modified for bioconda by Jon Puritz jpuritz@gmail.com
--- a/Makefile
+++ b/Makefile
@@ -7,17 +7,16 @@
 # this is aimed at making it easy to create packages (Debian packages,
 # FreeBSD ports, MacPorts, pkgsrc, etc.)
 
-CC ?=		cc
-CXX ?= 		c++
-CXXFLAGS ?=	-g -Wall -O2 #-m64 #-arch ppc
+CC ?=		$(CC)
+CXX ?= 		$(CXX)
+CXXFLAGS ?=	-g -Wall -O3 #-m64 #-arch ppc
 CXXFLAGS +=	-fPIC
 INCLUDES ?=	-Ihtslib
 HTS_HEADERS ?=	htslib/htslib/bgzf.h htslib/htslib/tbx.h
 HTS_LIB ?=	htslib/libhts.a
 LIBPATH ?=	-L. -Lhtslib
 
-DESTDIR ?=	stage
-PREFIX ?=	/usr/local
+PREFIX :=	$(PREFIX)
 STRIP ?=	strip
 INSTALL ?=	install -c
 MKDIR ?=	mkdir -p
@@ -30,30 +29,23 @@ SOVERSION =	1
 SLIB =		libtabix.so.$(SOVERSION)
 OBJS =		tabix.o
 SUBDIRS =	.
+SONUMBER =	0
 
 .SUFFIXES:.c .o
 
 .c.o:
 	$(CC) -c $(CXXFLAGS) $(DFLAGS) $(INCLUDES) $< -o $@
 
-all-recur lib-recur clean-recur cleanlocal-recur install-recur:
-	@target=`echo $@ | sed s/-recur//`; \
-	wdir=`pwd`; \
-	list='$(SUBDIRS)'; for subdir in $$list; do \
-		cd $$subdir; \
-		$(MAKE) CC="$(CC)" DFLAGS="$(DFLAGS)" CXXFLAGS="$(CXXFLAGS)" \
-			INCLUDES="$(INCLUDES)" LIBPATH="$(LIBPATH)" $$target \
-			|| exit 1; \
-		cd $$wdir; \
-	done;
+all:	$(BIN) $(LIB) $(SLIB) libtabixpp.so.$(SONUMBER) libtabixpp.a
 
-all:	$(BIN) $(LIB) $(SLIB)
-
-tabix.o: $(HTS_HEADERS) tabix.cpp tabix.hpp
+tabix.o: tabix.cpp tabix.hpp
 	$(CXX) $(CXXFLAGS) -c tabix.cpp $(INCLUDES)
 
-htslib/libhts.a:
-	cd htslib && $(MAKE) lib-static
+libtabixpp.a: tabix.o
+	ar rcs $@ $<
+
+libtabixpp.so.$(SONUMBER): tabix.o
+	$(CXX) -shared -o $@ $< -fPIC -Wl,-soname,libtabixpp.so.$(SONUMBER) $(LDFLAGS) -lhts
 
 $(LIB): $(OBJS)
 	$(AR) rs $(LIB) $(OBJS)
@@ -61,7 +53,7 @@ $(LIB): $(OBJS)
 $(SLIB): $(OBJS)
 	$(CXX) -shared -Wl,-soname,$(SLIB) -o $(SLIB) $(OBJS)
 
-tabix++: $(OBJS) main.cpp $(HTS_LIB)
+tabix++: $(OBJS) main.cpp
 	$(CXX) $(CXXFLAGS) -o $@ main.cpp $(OBJS) $(INCLUDES) $(LIBPATH) \
 		-lhts -lpthread -lm -lz -lcurl -llzma -lbz2
 
@@ -82,7 +74,6 @@ install-strip: install
 cleanlocal:
 	rm -rf $(BIN) $(LIB) $(SLIB) $(OBJS) $(DESTDIR)
 	rm -fr gmon.out *.o a.out *.dSYM $(BIN) *~ *.a tabix.aux tabix.log \
-		tabix.pdf *.class libtabix.*.dylib
-	cd htslib && $(MAKE) clean
+		tabix.pdf *.class libtabix*.dylib libtabix*so*
 
-clean:	cleanlocal-recur
+clean:	cleanlocal
