{% set version = "4.0.0" %}

package:
  name: deeptools
  version: {{ version }}

source:
  # url: https://github.com/deeptools/deepTools/archive/refs/tags/{{ version }}.tar.gz
  # sha256: f6dda39f552624758a9830cd4589ef43e7047284759b103cf833271cfa564dd1
  git_url: https://github.com/deeptools/deepTools.git
  git_rev: 4d2812ffa2da20021683750d234929f4da15d290
  sha256: ignored

build:
  number: 0
  # enable if facing issues with local builds
  skip: true  # [py >= 313]
  run_exports:
    - {{ pin_subpackage("deeptools", max_pin="x") }}
  script: |
    set -xe
    export LANG=C.UTF-8
    export LC_ALL=C.UTF-8

    export RUST_BACKTRACE=1
    export CARGO_TERM_VERBOSE=true
    # export RUSTC_LOG=rustc_codegen_ssa::back::link=info

    export LIBCLANG_PATH=$PREFIX/lib # [linux]
    export HTS_STATIC=1
    export MACOSX_DEPLOYMENT_TARGET=13.0 # [osx and x86-64]
    cargo-bundle-licenses --format yaml --output RUST_THIRDPARTY.yml
    # build the wheel with maturin, then install it with pip
    maturin build -b pyo3 --interpreter "${PYTHON}" --release --strip --skip-auditwheel
    {{ PYTHON }} -m pip install ./target/wheels/*.whl --no-deps --no-build-isolation -vvv
  entry_points:
    #- alignmentSieve = deeptools.alignmentSieve:main
    #- bamCompare = deeptools.bamCompare:main
    #- bamCoverage = deeptools.bamCoverage:main
    - bamPEFragmentSize = deeptools.bamPEFragmentSize:main
    - bigwigAverage = deeptools.bigwigAverage:main
    - bigwigCompare = deeptools.bigwigCompare:main
    - computeGCBias = deeptools.computeGCBias:main
    #- computeMatrix = deeptools.computeMatrix:main
    - computeMatrixOperations = deeptools.computeMatrixOperations:main
    - correctGCBias = deeptools.correctGCBias:main
    - deeptools = deeptools.deeptools_list_tools:main
    - estimateReadFiltering = deeptools.estimateReadFiltering:main
    - estimateScaleFactor = deeptools.estimateScaleFactor:main
    #- multiBamSummary = deeptools.multiBamSummary:main
    - multiBigwigSummary = deeptools.multiBigwigSummary:main
    - plotCorrelation = deeptools.plotCorrelation:main
    - plotCoverage = deeptools.plotCoverage:main
    - plotEnrichment = deeptools.plotEnrichment:main
    - plotFingerprint = deeptools.plotFingerprint:main
    - plotHeatmap = deeptools.plotHeatmap:main
    - plotPCA = deeptools.plotPCA:main
    - plotProfile = deeptools.plotProfile:main
    - alignmentSieve = deeptools.alignmentSieve2:main
    - bamCompare = deeptools.bamCompare2:main
    - bamCoverage = deeptools.bamCoverage2:main
    - computeMatrix = deeptools.computeMatrix2:main
    - multiBamSummary = deeptools.multiBamSummary2:main

requirements:
  build:
    - {{ compiler('rust') }}
    - make
    - cargo-bundle-licenses
  host:
    - python
    - pip
    - maturin
    - clangdev
  run:
    # - python
    - pybigwig >=0.2.1
    - numpy >=2.0.0
    - numpydoc >=0.5
    - scipy >=0.17.0
    - matplotlib-base >=3.5.0
    - pysam >=0.14.0
    - py2bit >=0.2.0
    - plotly >=4.9
    - deeptoolsintervals >=0.1.8
    - importlib-metadata

test:
  imports:
    - deeptools
  commands:
    - bamCompare --version

about:
  home: https://github.com/deeptools/deepTools
  license: MIT
  license_family: MIT
  license_file:
    - LICENSE.txt
    - RUST_THIRDPARTY.yml
  summary: A set of user-friendly tools for normalization and visualzation of deep-sequencing data
  doc_url: https://deeptools.readthedocs.io/en/latest/
  dev_url: https://github.com/deeptools/deepTools

extra:
  identifiers:
    - biotools:deeptools
    - doi:10.1093/nar/gkw257
    - usegalaxy-eu:deeptools_plot_heatmap
    - usegalaxy-eu:deeptools_plot_pca
    - usegalaxy-eu:deeptools_plot_profile
    - usegalaxy-eu:deeptools_plot_correlation
    - usegalaxy-eu:deeptools_plot_coverage
    - usegalaxy-eu:deeptools_plot_fingerprint
    - usegalaxy-eu:deeptools_plot_enrichment
    - usegalaxy-eu:deeptools_bam_compare
    - usegalaxy-eu:deeptools_bam_pe_fragmentsize
    - usegalaxy-eu:deeptools_bigwig_compare
    - usegalaxy-eu:deeptools_correct_gc_bias
    - usegalaxy-eu:deeptools_multi_bam_summary
    - usegalaxy-eu:deeptools_compute_matrix
    - usegalaxy-eu:deeptools_compute_gc_bias
    - usegalaxy-eu:deeptools_multi_bigwig_summary
    - usegalaxy-eu:deeptools_compute_matrix_operations
    - usegalaxy-eu:deeptools_alignmentsieve
    - usegalaxy-eu:deeptools_estimatereadfiltering
    - usegalaxy-eu:hicup_deduplicator
    - usegalaxy-eu:deeptools_bigwig_average
  skip-lints:
    - uses_vcs_url
  additional-platforms:
    #- linux-aarch64
    - osx-arm64
